<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width"/>
    <title>后台管理-限制IP地址</title>
    <link href="../../Content/Admin/css/bootstrap-cerulean.min.css" rel="stylesheet"/>
    <link href="../../Content/Admin/css/charisma-app.css" rel="stylesheet"/>
    <link href="../../Content/common.css" rel="stylesheet"/>
    <style type="text/css">
        .panel-body .row {
            margin: 15px 0;
        }

        .panel-body .row div:first-child {
            text-align: right;
            min-width: 120px;
        }

        .btn-outline-primary {
            border-right: 1px solid rgba(0, 0, 0, 0.3);
        }

        .panel-body input[type='text'] {
            max-width: 350px;
        }
        body{
            overflow-y: scroll!important;
        }
    </style>
</head>

<body>
<div id="content" class="main-content" style="display: none;" v-show="title">
    <div class="">
        <div class="carousel box-inner">
            <div class="box-header well clearfix" data-original-title="">
                <h2><i class="glyphicon glyphicon-hand-right"></i>目前操作功能：后台管理-黑名单</h2>
            </div>
            <div class="tab-content padding-margin-0">
                <div class="panel panel-primary no-bord">
                    <div class="panel-heading no-bord-radio">
                        <h3 class="panel-title">{{title}}</h3>
                    </div>
                    <div class="panel-body">
                        <div class="row" v-if="tab == 'ip'">
                            <div class="col-xs-2 col-md-1">限制IP地址：</div>
                            <div class="col-xs-6 col-md-3">
                                <input id="txtString" class="form-control input-sm" type="text" name="limitIP"
                                       v-model="info.AddrString" v-validate="'required|ip'" maxlength="31" value="">
                            </div>
                            <div class="col-xs-4 col-md-2 wrong" v-show="errors.has('limitIP')">请输入有效的IP地址</div>
                        </div>
                        <div class="row" v-else>
                            <div class="col-xs-2 col-md-1">限制手机号：</div>
                            <div class="col-xs-6 col-md-3">
                                <input id="txtString" class="form-control input-sm" type="text" name="limitTel"
                                       v-model="info.AddrString" v-validate="'required|mobile'" maxlength="31"
                                       value=""></div>
                            <div class="col-xs-4 col-md-2 wrong" v-show="errors.has('limitTel')">请输入有效的11位手机号码</div>
                        </div>
                        <div class="row">
                            <div class="col-xs-2 col-md-1">选项：</div>
                            <div class="col-xs-6 col-md-3">
                                <p class="checkbox-radio">
                                        <span class="break-word">
                                            <input type="checkbox" id="ckbEnjoinLogon" value="1"
                                                   v-model="info.EnjoinLogon"/>
                                            <label for="ckbEnjoinLogon">限制登录</label>
                                        </span>
                                    <span class="break-word">
                                            <input type="checkbox" id="ckbEnjoinRegister" value="1"
                                                   v-model="info.EnjoinRegister"/>
                                            <label for="ckbEnjoinRegister">限制注册</label>
                                        </span>
                                </p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-2 col-md-1">失效时间：</div>
                            <div class="col-xs-6 col-md-3">
                                <input id="txtEnjoinOverDate" style="width: 350px; display: inline;"
                                       class="laydate-icon strtime" type="text" readonly="readonly" placeholder="请输入时间"
                                       value="" v-model="info.EnjoinOverDate"/>
                            </div>
                            <div class="col-xs-4 col-md-2" style="text-align:left"></div>
                        </div>
                        <div class="row">
                            <div class="col-xs-2 col-md-1">警告：</div>
                            <div class="col-xs-8 col-md-8"><span style="color:red;">失效时间不填写，则默认为永久限制</span></div>
                        </div>
                        <div class="row">
                            <div class="col-xs-2 col-md-1">备注：</div>
                            <div class="col-xs-6 col-md-3">
                                    <textarea class="form-control" id="txtCollectNote"
                                              style="width:350px;display:inline;" rows="5" placeholder="备注"
                                              maxlength="32"
                                              v-model="info.CollectNote"></textarea>
                            </div>
                        </div>
                    </div>
                    <ul class="list-group">
                        <li class="list-group-item">
                            <ul class="list-inline">
                                <li><a class="btn btn-outline-primary btn-md" :href="'../heiMingDan.html?param='+tab"><i
                                        class="glyphicon glyphicon-circle-arrow-left"></i>返回</a></li>
                                <li><a class="btn btn-outline-success search btn-md" href="#" @click="add"><i
                                        class="glyphicon glyphicon-send"></i>保存</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../../Scripts/jquery-1.10.2.min.js"></script>
<script src="../../Scripts/comm.js"></script>
<script src="../../Content/laydate/laydate.js"></script>
<script src="../../Content/layui-v2.5.4/layui/layui.js"></script>
<script src="../../Scripts/vue.min.js"></script>
<script src="../../Content/veevalidate/vee-validate.js"></script>
<script src="../../Content/veevalidate/zh_CN.js"></script>
<script src="../../Content/veevalidate/config.js"></script>
<script type="text/javascript">
    layui.use(['layer'], function () {
        var layer = layui.layer
    })

    var myVue = new Vue({
        el: '#content',
        data: {
            tab: getUrlParams('tab'),
            title: getUrlParams('tab') == 'ip' ? '后台管理 - 限制IP地址' : '后台管理 - 限制手机号',
            param: getUrlParams('param'),
            info: {
                AddrString: '',//这个字段可能不一样
                EnjoinOverDate: '',
                CollectNote: '',
                EnjoinLogon: 1,
                EnjoinRegister: 1,
            }
        },
        mounted: function () {
            var that = this
            laydate.render({
                elem: '#txtEnjoinOverDate'
                , type: 'datetime'
                , theme: '#00B4E5'
                , done: function (value, date, endDate) {
                    that.info.EnjoinOverDate = value
                }
            });
            this.param = getUrlParams('param')
            if (this.param) {
                this.info = JSON.parse(getStorage("AddrString"))
                // var obj = JSON.parse(getStorage(param))
                // console.log(obj);
                // $("#txtString").val(obj.txtString);
                // $("#txtEnjoinOverDate").val(obj.EnjoinOverDate);
                // $("#txtCollectNote").val(obj.CollectNote);
                // $('#ckbEnjoinLogon').prop("checked", obj.EnjoinLogon == 1);
                // $('#ckbEnjoinRegister').prop("checked", obj.EnjoinRegister == 1);
                // 这样体验不好,刷新就没了
                // delStorage(this.param)
            }

        },
        methods: {
            add: function () {
                var that = this;
                var now = new Date();
                if (this.info.EnjoinOverDate < Time.today().NowDate) {
                // if (StrToDateTime(this.info.EnjoinOverDate).getDate() <= now.getDate()) {
                    layer.alert("失效时间不能小于当前时间");
                    that.info.EnjoinOverDate = ''
                    return false;
                }
                //新增/更新IP,是根据Param来判断的，为空是新增，不为空是更新
                var data = {
                    String: this.info.AddrString,
                    EnjoinOverDate: this.info.EnjoinOverDate == '永久限制' ? '' :this.info.EnjoinOverDate,
                    Param: this.param ? this.param : '',
                    CollectNote: this.info.CollectNote,
                    token: getStorage('token'),
                    EnjoinLogon: this.info.EnjoinLogon ? 1: 0,
                    EnjoinRegister: this.info.EnjoinRegister ? 1 : 0
                };
                this.$validator.validate().then(valid => {
                    if (valid) {
                        //ajax请求
                        if (that.tab == 'ip') {
                            $.ajax({
                                type: 'POST',
                                url: qp_url + 'admin/Account/AddConfineAddressInfo?token='+getStorage('token'),
                                data: data,
                                dataType: 'json',
                                success: function (res) {
                                    if (res.status == 1) {
                                        layer.msg(res.msg, {time: 1000, icon: 1})
                                        saveInfo(that.info);
                                        setTimeout(function () {
                                            window.location.href = '../heiMingDan.html?param=ip'
                                        }, 1000)
                                    } else {
                                        layer.msg(res.msg, {time: 1000, icon: 2})
                                    }
                                }
                            })
                        }
                        if (that.tab == 'tel') {
                            $.ajax({
                                type: 'POST',
                                url: qp_url + '/admin/Account/AddConfineMobileInfo?token='+getStorage('token'),
                                data: data,
                                dataType: 'json',
                                success: function (res) {
                                    if (res.status == 1) {
                                        layer.msg(res.msg, {time: 1000, icon: 1})
                                        saveInfo(that.info);
                                        setTimeout(function () {
                                            window.location.href = '../heiMingDan.html?param=tel'
                                        }, 1000)
                                    }else{
                                        layer.msg(res.msg, {time: 1000, icon: 2})
                                    }
                                }
                            })
                        }
                    } else {
                        layer.alert("无法添加,请检查输入的数据!")
                    }
                })
            }
        }
    })


    // var tab;//url中的参数，区分ip和手机号
    // var param;//url中的参数，区分是修改还是新增
    // $(function () {
    //     laydate.render({
    //         elem: '#txtEnjoinOverDate'
    //         , type: 'datetime'
    //         , theme: '#6D8DFD'
    //     });
    //     tab = getUrlParams('tab')//ip:配置ip信息；tel：配置手机号信息
    //     console.log(tab);
    //     // if (tab == 'ip') {
    //     //     $(".panel-title").text('后台管理 - 限制IP地址');
    //     // } else {
    //     //     $(".panel-title").text('后台管理 - 限制手机号');
    //     // }
    //
    // })
    //
    // //保存
    // function add() {
    //     var EnjoinOverDatestr = $("#txtEnjoinOverDate").val();
    //     var String = $("#txtString").val();
    //     if (String == "") {
    //         layer.alert("限制IP不能为空");
    //         return false;
    //     }
    //     if (EnjoinOverDatestr != "") {
    //         var EnjoinOverDate = StrToDateTime(EnjoinOverDatestr);
    //         var now = new Date();
    //         if (EnjoinOverDate.getDate() <= now.getDate()) {
    //             layer.alert("失效时间不能小于当前时间");
    //             return false;
    //         }
    //     }
    //     var CollectNote = $("#txtCollectNote").val();
    //     //新增/更新IP,是根据Param来判断的，为空是新增，不为空是更新
    //     var data = {
    //         String: String,
    //         EnjoinOverDate: EnjoinOverDatestr,
    //         Param: '',
    //         CollectNote: CollectNote
    //     };
    //     data.EnjoinLogon = $('#ckbEnjoinLogon').is(':checked') ? 1 : 0;
    //     data.EnjoinRegister = $('#ckbEnjoinRegister').is(':checked') ? 1 : 0;
    //     data.token = getStorage('token')
    //     data.Param = param ? param : ''
    //     console.log(data);
    //     if (tab == 'ip') {
    //         $.ajax({
    //             type: 'POST',
    //             url: qp_url + 'admin/Account/AddConfineAddressInfo',
    //             data: data,
    //             dataType: 'json',
    //             success: function (res) {
    //                 layer.alert(res.msg)
    //             }
    //         })
    //     }
    //     // AjaxSubmit("/Account/AddConfineAddressInfo", data, callBack, "add");
    // }
    //
    // function callBack(jsonData, fname) {
    //     switch (fname) {
    //         case "add":
    //             alert(jsonData.Msg);
    //             window.location.href = "/Account/ConfineAddressList"
    //             break;
    //     }
    // }
    //
    function StrToDateTime(timestr) {
        var dt = new Date(timestr.replace("-", "/").replace("-", "/"));
        return dt;
    }

    function saveInfo(obj) {
        setStorage("AddrString", JSON.stringify({
            AddrString: obj.AddrString,
            CollectDate: obj.CollectDate,
            CollectNote: obj.CollectNote,
            EnjoinLogon: obj.EnjoinLogon,
            EnjoinOverDate: obj.EnjoinOverDate,
            EnjoinRegister: obj.EnjoinRegister,
            LAY_TABLE_INDEX: obj.LAY_TABLE_INDEX,
        }))
    }
</script>
</body>

</html>
