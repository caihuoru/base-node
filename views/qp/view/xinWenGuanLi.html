<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>网站系统 - 新闻公告</title>
    <link href="../Content/Admin/css/bootstrap-cerulean.min.css" rel="stylesheet" />
    <link href="../Content/Admin/css/charisma-app.css" rel="stylesheet" />
    <link rel="stylesheet" href="../Content/layui-v2.5.4/layui/css/layui.css">
    <link href="../Content/common.css" rel="stylesheet" />
    <style type="text/css">
        body {
            overflow-y: scroll !important;
        }
    </style>
</head>

<body class="backgroud">
    <div id="content" class="main-content">
        <div class="row">
            <div class="col-md-12">
                <div class="box-inner">
                    <div class="box-header well" data-original-title="">
                        <h2><i class="glyphicon glyphicon-hand-right"></i> 你当前位置：网站系统 - 新闻公告 </h2>
                        <div class="box-icon">
                            <a href="#" class="btn btn-round btn-default" onclick="history.go(0);">
                                <i class="glyphicon glyphicon-repeat"></i>
                            </a>
                            <a href="#" class="btn btn-minimize btn-round btn-default">
                                <i class="glyphicon glyphicon-chevron-up"></i>
                            </a>
                        </div>
                    </div>
                    <ul class="media nav nav-tabs margin-b-10">
                        <li class="active">
                            <a href="javascript:void(0);">新闻公告</a>
                        </li>
                        <li>
                            <a href="add/MobileNoticeList.html">移动版公告</a>
                        </li>
                    </ul>
                    <div class="box-content" style="overflow: hidden; display: block;">
                        <div class="row">
                            <div class="col-md-12" style="padding-bottom:5px; padding-top:5px; text-align:right;">
                                <a href="./add/NewsInfo.html" class="btn btn-outline-success"> <i
                                        class="glyphicon glyphicon-plus-sign icon-white"></i>新增 </a>
                                <button type="button" class="btn btn-danger" onclick="Del(0);"> <i
                                        class="glyphicon glyphicon-trash icon-white"></i>删除 </button>
                            </div>
                        </div>
                        <!--table开始-->
                        <div id="DataTables_Table_0_wrapper" class="dataTables_wrapper table-center" role="grid">
                            <table id="layTable" lay-filter="test"></table>
                        </div>
                        <!--table结束-->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="../Scripts/jquery-1.10.2.min.js"></script>
    <script src="../Scripts/comm.js"></script>
    <script src="../Content/layui-v2.5.4/layui/layui.js"></script>
    <script type="text/javascript">
        var pageObj = {};
        var postData = {};//搜索条件
        postData.ID = '';
        //使用layui的数据表格，需要定义一个全局变量存储选中行的数据
        var selectRows = [];
        layui.use('table', function () {
            var table = layui.table;

            //第一个实例
            table.render({
                elem: '#layTable'
                // , height: 512
                , url: qp_url + '/admin/Web/NoticeList?token=' + getStorage('token')
                , request: {
                    pageName: 'pageIndex' //页码的参数名称，默认：page
                    , limitName: 'pageSize' //每页数据量的参数名，默认：limit
                }
                , response: { //res 即为原始返回的数据
                    statusName: 'status',
                    statusCode: 1,
                    // msgName: 'msg',
                    // dataName: 'data',
                },
                parseData: function (res) {
                    console.log(res)
                    return {
                        "status": res.status, //解析接口状态
                        "msg": res.msg, //解析提示文本
                        "count": res.data.total, //解析数据长度 ,需要数据库返回
                        "data": res.data.data //解析数据列表
                    };
                }
                , page: {
                    'theme': '#2D2D3C'
                } //开启分页
                , limits: [10, 20, 30, 50, 80, 100]
                , limit: 50
                , cols: [[ //表头
                    { type: 'checkbox' }
                    , { field: 'title', title: '标题' }
                    , {
                        field: 'type', title: '类别', templet: function (d) {
                            if (d.type == 1) {
                                return `<span >新闻公告</span>`
                            } else {
                                return `<span >移动版公告</span>`
                            }
                        }
                    }
                    , {
                        field: 'sort', title: '排序权重', templet: function (d) {
                            return `<div data-id=${d.id} contenteditable="true" class="sort">${d.sort}</div>`
                        }
                    }
                    , {
                        field: 'status', title: '状态', templet: function (d) {
                            if (d.status == 1) {
                                return `<span class="normal">启用</span>`
                            } else {
                                return `<span class="wrong">禁用</span>`
                            }
                        }
                    }
                    , { field: 'addtime', title: '时间' }
                    , {
                        field: 'status', title: '管理', templet: function (d) {
                            if (d.status == 1) {
                                return `<span class="layui-btn layui-btn-xs layui-btn-normal" onclick="window.open('./add/NewsInfo.html?id=${d.id}','_self')" lay-event="edit">更新</span>
                                        <span class="layui-btn layui-btn-warm layui-btn-xs" lay-event="del" onclick='editStatus(${d.id}, 1)'>禁用</span>`
                            } else {
                                return `  <span class="layui-btn layui-btn-xs layui-btn-normal" onclick="window.open('./add/NewsInfo.html?id=${d.id}','_self')" lay-event="edit">更新</span>
                                          <span class="layui-btn layui-btn-normal layui-btn-xs" lay-event="del" onclick='editStatus(${d.id},0)'>启用</span>`
                            }
                        }
                    }
                ]]
                , done: function (res, curr, count) {
                    $('th').css({ 'text-align': 'center' });
                }

            });
            //监听复选框选择事件
            table.on('checkbox(test)', function (obj) {
                var checkStatus = table.checkStatus('layTable'); //idTest 即为基础参数 id 对应的值
                selectRows = checkStatus.data
            });
            $(document).on("blur", ".sort", function () {
                $.ajax({
                    type: 'POST',
                    url: qp_url + "admin/Web/editNoticeSort?token=" + getStorage('token'),
                    dataType: 'json',
                    data: {
                        id: Number($(this).data("id")),
                        sort: Number($(this).html())
                    },
                    success: function (resData) {
                        if (resData.status == 1) {
                            layer.msg(resData.msg, { time: 2000, icon: 1 });
                            table.reload('layTable', {
                                page: {
                                    curr: 1
                                }
                            })
                        } else {
                            layer.msg(resData.msg, { time: 2000, icon: 2 });
                        }

                    }
                })
            })
        });

        function Del(o) {
            var data = {};
            if (o == 0) {
                // var cid = GetSelectValues();
                var cid = GetSelectedDatas(selectRows, 'id');
                if (cid == "") {
                    layer.alert('未选中任何数据', {
                        icon: 7,
                        skin: 'layer-ext-moon'
                    })
                    return;
                }
                data = { ids: cid };
            } else {
                data.ids = o;
            }
            if (confirm("确定删除吗？")) {
                $.ajax({
                    type: 'POST',
                    url: qp_url + "admin/Web/DelNotice?token=" + getStorage('token'),
                    dataType: 'json',
                    data: data,
                    success: function (resData) {
                        if (resData.status == 1) {
                            layer.msg(resData.msg, { time: 2000, icon: 1 });
                            setTimeout(function () {
                                window.history.go(0)
                            }, 1500)
                        } else {
                            layer.msg(resData.msg, { time: 2000, icon: 2 });
                        }
                    }
                })
            }
        }

        function editStatus(id, status) {
            if (status == 1) {
                status = 0;
            } else {
                status = 1;
            }
            $.ajax({
                type: 'POST',
                url: qp_url + "admin/Web/editNoticeStatus?token=" + getStorage('token'),
                dataType: 'json',
                data: {
                    id: id,
                    status: status
                },
                success: function (resData) {
                    if (resData.status == 1) {
                        layer.msg(resData.msg, { time: 2000, icon: 1 });
                        setTimeout(function () {
                            window.history.go(0)
                        }, 500)
                    } else {
                        layer.msg(resData.msg, { time: 2000, icon: 2 });
                    }

                }
            })
        }
    </script>
</body>

</html>
