<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>修改个人资料</title>
    <link href="../Content/Admin/css/bootstrap-cerulean.min.css" rel="stylesheet"/>
    <link href="../Content/Admin/css/charisma-app.css" rel="stylesheet"/>
    <link rel="stylesheet" href="../Content/layui-v2.5.4/layui/css/layui.css">
    <link href="../Content/common.css" rel="stylesheet"/>
    <link href="../Content/index.css" rel="stylesheet"/>
    <style>
        body .form-control {
            display: inline-block;
        }

        .layui-table-cell {
            text-align: center;
        }
    </style>
</head>
<body class="backgroud">
<div id="content" class="main-content" style="padding-bottom: 0;">
    <div class="row">
        <div class="col-md-12">
            <div class="box-inner ">
                <div class="box-header well" data-original-title="">
                    <h2><i class="glyphicon glyphicon-hand-right"></i> 你当前位置：修改个人资料 </h2>
                    <div class="box-icon">
                        <a href="#" class="btn btn-round btn-default" onclick="history.go(0);">
                            <i class="glyphicon glyphicon-repeat"></i>
                        </a>
                        <a href="#" class="btn btn-minimize btn-round btn-default">
                            <i class="glyphicon glyphicon-chevron-up"></i>
                        </a>
                    </div>
                </div>
                <div class="tab-content" id="table">
                    <div class="panel panel-primary" style="border: none;box-shadow: none">
                        <div class="panel-body">
                            <form class="layui-form" method="post" action="#" lay-filter="component-form-element">
                                <div class="row">
                                    <div class="col-xs-2 col-md-1 layui-form-label">头像：</div>
                                    <div class="col-xs-6 col-md-3">
                                        <img :src="add.avatar || '../Content/images/headImg.png'" alt=""
                                             style="width: 100px;height: 100px;border-radius: 100px;margin-bottom: 30px;">
                                        <input type="file" id="upFile">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-2 col-md-1 layui-form-label">昵称：</div>
                                    <div class="col-xs-6 col-md-3">
                                        <input
                                                style="width: 100%;max-width: 400px"
                                                name="name"
                                                v-validate="'required'"
                                                :class="{'is-danger': errors.has('name') }"
                                                v-model="add.realname" placeholder="请填写客服账号" class="form-control"
                                                type="text" value="">
                                    </div>
                                    <div class="col-xs-4 col-md-2 wrong" v-show="errors.has('name')">
                                        {{ errors.first('name') }}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-2 col-md-1 layui-form-label">密码：</div>
                                    <div class="col-xs-6 col-md-3">
                                        <input
                                                style="width: 100%;max-width: 400px"
                                                type="password"
                                                name="password"
                                                class="form-control"
                                                placeholder="无需更改请勿填写"
                                                v-validate="'min:6'"
                                                v-model="pass_word"
                                                :class="{'is-danger': errors.has('password') }"
                                        >
                                    </div>
                                    <div class="col-xs-4 col-md-2 wrong" v-show="errors.has('password')">
                                        {{ errors.first('password') }}
                                    </div>
                                </div>
                                <div class="row" v-if="pass_word">
                                    <div class="col-xs-2 col-md-1 layui-form-label">确认密码：</div>
                                    <div class="col-xs-6 col-md-3">
                                        <input
                                                style="width: 100%;max-width: 400px"
                                                type="password"
                                                name="repeat"
                                                class="form-control"
                                                placeholder="再次填写密码"
                                                v-model="repeat"
                                                v-validate="'required|repeat'"
                                                :class="{'is-danger': errors.has('repeat') }">
                                    </div>
                                    <div class="col-xs-4 col-md-2 wrong" v-show="errors.has('repeat')">
                                        {{ errors.first('repeat') }}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-2 col-md-1 layui-form-label"></div>
                                    <div class="col-xs-6 col-md-3">
                                        <a class="btn btn-outline-success search btn-md" href="#" @click="gameSub"><i
                                                class="glyphicon glyphicon-send"></i> 保存</a>
                                    </div>
                                </div>
                            </form>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../Scripts/jquery-1.10.2.min.js"></script>
<script src="../Scripts/axios.js"></script>
<script src="../Scripts/vue.min.js"></script>
<script src="../Scripts/comm.js"></script>
<script src="../Scripts/socket.io.js"></script>
<script src="../Content/laydate/laydate.js"></script>
<script src="../Scripts/pagination.js"></script>
<script src="../Content/layui-v2.5.4/layui/layui.js"></script>
<!--验证插件-->
<script src="../Content/veevalidate/vee-validate.js"></script>
<script src="../Content/veevalidate/zh_CN.js"></script>
<script src="../Content/veevalidate/config.js"></script>
<script type="text/javascript">
    //收放事件
    $('.btn-minimize').click(function (e) {
        e.preventDefault();
        var $target = $(this).parent().parent().next('.box-content');
        if ($target.is(':visible')) $('i', $(this)).removeClass('glyphicon-chevron-up').addClass('glyphicon-chevron-down');
        else $('i', $(this)).removeClass('glyphicon-chevron-down').addClass('glyphicon-chevron-up');
        $target.slideToggle();
    });
    var layer, form;

    var app = new Vue({
        el: '#table',
        data: {
            current: 'alipay',
            title: '',
            list: [],
            pass_word: '',
            repeat: '',
            add: {
                nickName: '123123123',
            }
        },
        mounted: function () {
            var _this = this;
            layui.use(['layer', 'form'], function () {
                layer = layui.layer;
                form = layui.form;
                let postData = {
                    doing: 'getUserInfo',
                    token: getStorage('token')
                }
                axios({
                    method: 'post',
                    url: request_url2 + 'getCustomers',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    data: postData,
                }).then(function (res) {
                    var resData = res.data;
                    console.log(resData)
                    if (resData.code == '0') {
                        if(resData.body.length < 1){
                            layer.msg('获取信息失败,请重新登陆', {icon: 2, time: 2000}, function () {
                                setStorage('loginUrl',window.location.href)
                                window.location.href = 'login.html'
                            });
                        }else{
                            _this.add = resData.body[0]
                        }
                    } else {
                        layer.msg(resData.msg, {icon: 2, time: 2000});
                    }
//                        app.recommendList = data;
//                        tableSearchInit(data);
                })
            });

        },
        methods: {
            gameSub: function () {
                let postData = {
                    doing: 'edit',
                    body: this.add
                };
                if (this.pass_word) {
                    this.$validator.validate().then(valid => {
                        console.log(valid)
                        if (valid) {
                            postData['body']['pass_word'] = this.pass_word
                            this.submit(postData)
                        }
                    })
                } else {
                    this.submit(postData)
                }
            },
            submit(postData) {
                axios({
                    method: 'post',
                    url: request_url2 + "getCustomers",
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    data: postData,
                }).then(function (res) {
                    console.log(res)
                    var data = res.data
                    if (data.code == 0) {
                        layer.msg(data.msg,{icon: 1, time: 2000})
                        console.log($(parent.avatar))
                        console.log(postData.body.avatar)
                        $(parent.avatar).attr('src',postData.body.avatar)
                        $(parent.realname).text(postData.body.realname)
                        setStorage('customerInfo', JSON.stringify(postData.body))
                    } else {
                        layer.msg(data.msg,{icon: 2, time: 2000})
                    }
                })
            }
        }
    });
    var bindUser = "", bindUserName;
    // 用户点击发送表情
    $(document).on('change', '#upFile', function (e) {
        var maxWidth = 300;
        //判断上传文件格式
        console.log(this.files[0])
        if (!this.files[0].type.match(/image\/*/)) {
            return swal('上传的图片格式不正确')
        }
        var file = this.files[0];
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function (e) {
            // 实例一个图片获取图片宽高
            var img = new Image();
            img.src = this.result;
            img.onload = function () {
                var _height = img.height, _width = img.width;
                if (_width > maxWidth) {
                    var scale = maxWidth / _width;
                    _width = toFixed2(_width * scale);
                    _height = toFixed2(_height * scale);
                }
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                canvas.width = _width;
                canvas.height = _height;
                ctx.drawImage(img, 0, 0, _width, _height);
                var imgToBase64 = canvas.toDataURL();
                // $('body').append('<img src="' + imgToBase64 + '" style="width:100%;margin: 0">');
                $.ajax({
                    type: 'POST',
                    url: serverPath + 'saveImg.php',
                    dataType: 'json',
                    data: {
                        name: getDateString('', 'number') + '.' + getRandomNumber(8),
                        image: imgToBase64
                    },
                    success: function (data) {
                        var resData = data;
                        console.log(resData)
                        app.add.avatar = resData.imgPath                        // console.log(code);
                    },
                    error: function () {
                        console.log('出错了！');//原有的提示，建议改善
                    }
                });


            }
        }
    })


</script>
</body>

</html>
