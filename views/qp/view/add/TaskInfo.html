<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width"/>
    <title></title>
    <link href="../../Content/Admin/css/bootstrap-cerulean.min.css" rel="stylesheet"/>
    <link href="../../Content/Admin/css/charisma-app.css" rel="stylesheet"/>
    <link href="../../Content/common.css" rel="stylesheet"/>
    <style type="text/css">
        .panel-body .row div:first-child {
            width: 120px;
            text-align: right;
        }

        .panel-body .row input[type='text'] {
            max-width: 350px;
            display: inline;;
        }

        body {
            overflow-y: scroll !important;
        }
    </style>
</head>
<body>
<div id="content" class="main-content" style="display: none;" v-show="info">
    <div class="carousel box-inner">
        <div class="box-header well clearfix" data-original-title="">
            <h2><i class="glyphicon glyphicon-hand-right"></i>目前操作功能：任务系统 - 任务管理</h2>
        </div>
        <div class="tab-content padding-margin-0">
            <div class="panel panel-info no-bord">
                <div class="panel-heading no-bord-radio">
                    <h3 class="panel-title">任务信息</h3>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-xs-2 col-md-2">任务名称：</div>
                        <div class="col-xs-6 col-md-3">
                            <input id="txtTaskName" class="form-control input-sm" type="text" value=""
                                   v-model="info.TaskName"
                                   name="TaskName"
                                   v-validate="'required'">
                        </div>
                        <div class="col-xs-4 col-md-2 wrong" v-show="errors.has('TaskName')">
                            <label style="color:red;">*请输入任务名称</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-2 col-md-2">任务类型：</div>
                        <div class="col-xs-6 col-md-3">
                            <select class="form-control input-sm input-width-200" id="ddlTaskType"
                                    v-model="info.TaskType">
                                <option value="0">==请选择任务类型==</option>
                                <option :value="item.type" v-for="item in taskList">{{item.name}}</option>
                            </select>
                        </div>
                        <div class="col-xs-3 col-md-3">

                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-2 col-md-2">可领取任务用户类型：</div>
                        <div class="col-xs-6 col-md-3">
                            <select id="cblUserType" class="form-control input-sm input-width-200"
                                    v-model="info.UserType">
                                <option value="1">普通玩家</option>
                                <option value="2">会员玩家</option>
                            </select>
                        </div>
                        <div class="col-xs-6 col-md-3">

                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-2 col-md-2">所属游戏：</div>
                        <div class="col-xs-6 col-md-3">
                            <select class="form-control input-sm input-width-200" id="ddlGameKind"
                                    v-model="info.KindID">
                                <option value="-1">==请选择所属游戏==</option>
                                <option :value="item.KindID" v-for="item in gameList">{{item.KindName}}</option>
                            </select>
                        </div>
                        <div class="col-xs-6 col-md-3">

                        </div>
                    </div>
                    <div class="row" v-if="info.UserType == 1">
                        <div class="col-xs-2 col-md-2">普通玩家奖励金币：</div>
                        <div class="col-xs-6 col-md-3">
                            <input id="txtStandardAwardGold" class="form-control input-sm" type="text"
                                   onkeyup="if(isNaN(value))execCommand('undo');" value=""
                                   v-model="info.StandardAwardGold"
                                   name="StandardAwardGold"
                                   v-validate="'required|decimal:2|min_value:0'">
                        </div>
                        <div class="col-xs-3 col-md-3 wrong" v-show="errors.has('StandardAwardGold')">
                            <label style="color:red;">*请输入奖励金币数</label>
                        </div>
                    </div>
                    <div class="row" v-else>
                        <div class="col-xs-2 col-md-2">会员玩家奖励金币：</div>
                        <div class="col-xs-6 col-md-3">
                            <input id="txtMemberAwardGold" class="form-control input-sm" type="text"
                                   onkeyup="if(isNaN(value))execCommand('undo');" value=""
                                   v-model="info.MemberAwardGold"
                                   name="MemberAwardGold"
                                   v-validate="'required|decimal:2|min_value:0'">
                        </div>
                        <div class="col-xs-3 col-md-3" v-show="errors.has('MemberAwardGold')">
                            <label style="color:red;">*输入会员玩家奖励金币</label>
                        </div>
                    </div>
                    <div class="row" style="display: none">
                        <div class="col-xs-2 col-md-2">普通玩家奖励元宝：</div>
                        <div class="col-xs-6 col-md-3">
                            <input id="txtStandardAwardMedal" class="form-control input-sm" type="text"
                                   onkeyup="if(isNaN(value))execCommand('undo');" value=""
                                   v-model="info.StandardAwardMedal"
                                   name="StandardAwardMedal"
                                   v-validate="'required'">
                        </div>
                        <div class="col-xs-3 col-md-3" v-show="errors.has('StandardAwardMedal')">
                            <label style="color:red;">*输入普通玩家奖励元宝</label>
                        </div>
                    </div>
                    <div class="row" style="display: none">
                        <div class="col-xs-2 col-md-2">会员玩家奖励元宝：</div>
                        <div class="col-xs-6 col-md-3">
                            <input id="txtMemberAwardMedal" class="form-control input-sm" type="text"
                                   onkeyup="if(isNaN(value))execCommand('undo');" value=""
                                   v-model="info.MemberAwardMedal"
                                   name="MemberAwardMedal"
                                   v-validate="'required'">
                        </div>
                        <div class="col-xs-3 col-md-3" v-show="errors.has('MemberAwardMedal')">
                            <label style="color:red;">*输入会员玩家奖励元宝</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-2 col-md-2">时间限制：</div>
                        <div class="col-xs-6 col-md-3">
                            <input id="txtTimeLimit" class="form-control input-sm inline" type="text"
                                   onkeyup="if(isNaN(value))execCommand('undo');" value=""
                                   v-model="info.TimeLimit"
                                   name="TimeLimit"
                                   v-validate="'required|decimal:0|min_value:1'">
                        </div>
                        <div class="col-xs-3 col-md-3">
                            (单位:秒)
                            <label style="color:red;" v-show="errors.has('TimeLimit')">*时间限制应为整型</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-2 col-md-2">目标局数：</div>
                        <div class="col-xs-6 col-md-3">
                            <input id="txtInnings" class="form-control input-sm" type="text"
                                   onkeyup="if(isNaN(value))execCommand('undo');" value=""
                                   v-model="info.Innings"
                                   name="Innings"
                                   v-validate="'required|decimal:0|min_value:1'">
                        </div>
                        <div class="col-xs-3 col-md-3" v-show="errors.has('Innings')">
                            <label style="color:red;">*目标局数为整数，且不能低于1局</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-2 col-md-2">任务描述：</div>
                        <div class="col-xs-6 col-md-3">
                            <textarea id="txtTaskDescription" class="form-control " rows="3"
                                      v-model="info.TaskDescription"></textarea>
                        </div>
                        <div class="col-xs-3 col-md-3">
                            不允许超过500个字。
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-xs-2 col-md-2"></div>
                        <div class="col-xs-6 col-md-6">
                            <label style="color:red;">注意：修改成功后游戏中生效的时间为20分钟</label>
                        </div>
                        <div class="col-xs-3 col-md-3">

                        </div>
                    </div>
                </div>
                <ul class="list-group">
                    <li class="list-group-item">
                        <ul class="list-inline">
                            <li><a class="btn btn-outline-primary search btn-md" href="../renWuGuanLi.html"><i
                                    class="glyphicon glyphicon-arrow-left"></i>返回</a></li>
                            <li><a class="btn btn-outline-success search btn-md" href="#" @click="add"><i
                                    class="glyphicon glyphicon-save"></i>保存</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>

    </div>
</div>
<script src="../../Scripts/jquery-1.10.2.min.js"></script>
<script src="../../Scripts/comm.js"></script>
<script src="../../Scripts/vue.min.js"></script>
<script src="../../Content/veevalidate/vee-validate.js"></script>
<script src="../../Content/veevalidate/zh_CN.js"></script>
<script src="../../Content/veevalidate/config.js"></script>
<script src="../../Content/layui-v2.5.4/layui/layui.js"></script>
<script type="text/javascript">
    layui.use(['layer'], function () {
        var layer = layui.layer
    })
    var myVue = new Vue({
        el: '#content',
        data: {
            info: {
                TaskID: 0,
                TaskName: "",
                TaskType: 0,
                UserType: 1,
                KindID: -1,
                StandardAwardGold: "1.00",
                StandardAwardMedal: 0,
                MemberAwardGold: "0.00",
                MemberAwardMedal: 0,
                TimeLimit: 0,
                Innings: 1,
                TaskDescription: "大家玩游戏吧",
                // MatchID: 0,
                // InputDate: "2018-01-28 16:33:28",
                // Nullity: 1
            },
            gameList: [],
            taskList: []
        },
        mounted: function () {
            var that = this
            console.log('124');
            //编辑的时候获取任务详情
            if (getUrlParams('id')) {//编辑
                $.post(qp_url + 'admin/task/TaskInfo?token='+getStorage('token'), {
                    param: getUrlParams('id')
                }, function (res) {
                    console.log(res.data);
                    that.info = res.data.taskInfo
                }, 'json')
            } else {
                this.info = {
                    TaskID: 0,
                    TaskName: "",
                    TaskType: 0,
                    UserType: 1,
                    KindID: -1,
                    StandardAwardGold: "0.00",
                    StandardAwardMedal: 0,
                    MemberAwardGold: "0.00",
                    MemberAwardMedal: 0,
                    TimeLimit: 0,
                    Innings: 1,
                    TaskDescription: "大家玩游戏吧",
                    // MatchID: 0,
                    // InputDate: "2018-01-28 16:33:28",
                    // Nullity: 1
                }
            }
            //获取游戏列表
            $.post(qp_url + 'admin/Gamecommon/GetGameList?token=' + getStorage('token'), function (res) {
                if (res.status == 1) {
                    that.gameList = res.data
                }
            }, 'json')
            //获取任务类型
            $.get(qp_url + 'admin/task/getTaskType?token='+getStorage('token'), function (res) {
                if (res.status == 1) {
                    that.taskList = res.data
                }
            }, 'json')
        },
        methods: {
            add: function () {
                var postData = this.info;
                if (parseInt(postData.TaskType) < 1) {
                    layer.alert("请选择任务类型");
                    return false;
                }
                if (parseInt(postData.KindID) < 1) {
                    layer.alert("请选择所属游戏");
                    return false;
                }
                console.log(postData);

                //针对普通玩家，将会员玩家对应的奖励金币和元宝归0，
                //针对会员玩家，将普通玩家对应的经理金币和元宝归0

                if (postData.UserType == 1) {//普通玩家
                    postData.MemberAwardGold = 0
                    postData.MemberAwardMedal = 0
                }
                if (postData.UserType == 2) {//会员玩家
                    postData.StandardAwardGold = 0
                    postData.StandardAwardMedal = 0
                }

                this.$validator.validate().then(valid => {
                    console.log(valid)
                    if (valid) {
                        $.post(qp_url + 'admin/task/DoTaskInfo?token='+getStorage('token'), postData, function (res) {
                            if (res.status == 1) {
                                layer.msg(res.msg, {time: 1000, icon: 1});
                                setTimeout(function () {
                                    window.location.href = '../renWuGuanLi.html'
                                },1000)
                            } else {
                                layer.msg(res.msg, {time: 1000, icon: 2});
                            }
                        }, 'json')
                    }
                })
            }
        }
    })

    function add() {
        var data = {};
        data.TaskID = parseInt('0');
        var TaskName = $("#txtTaskName").val().trim();
        if (TaskName == "") {
            layer.alert("任务名称不能为空");
            return false;
        }
        data.TaskName = TaskName;

        var TaskType = $("#ddlTaskType").val().trim();
        if (parseInt(TaskType) < 1) {
            alert("请选择任务类型");
            return false;
        }
        data.TaskType = TaskType;

        var UserType = $("#cblUserType").val().trim();
        data.UserType = UserType;

        var GameKind = $("#ddlGameKind").val().trim();
        if (parseInt(GameKind) < 1) {
            alert("请选择所属游戏");
            return false;
        }
        data.KindID = GameKind;

        var StandardAwardGold = $("#txtStandardAwardGold").val().trim();
        if (StandardAwardGold == "" || isNaN(StandardAwardGold)) {
            alert("普通玩家奖励金币不能为空且为整数");
            return false;
        }
        data.StandardAwardGold = StandardAwardGold;

        var StandardAwardMedal = $("#txtStandardAwardMedal").val().trim();
        if (StandardAwardMedal == "" || isNaN(StandardAwardMedal)) {
            alert("普通玩家奖励元宝不能为空且为整数");
            return false;
        }
        data.StandardAwardMedal = StandardAwardMedal;

        var MemberAwardGold = $("#txtMemberAwardGold").val().trim();
        if (MemberAwardGold == "" || isNaN(MemberAwardGold)) {
            alert("会员玩家奖励金币不能为空且为整数");
            return false;
        }
        data.MemberAwardGold = MemberAwardGold;

        var MemberAwardMedal = $("#txtMemberAwardMedal").val().trim();
        if (MemberAwardMedal == "" || isNaN(MemberAwardMedal)) {
            alert("会员玩家奖励元宝不能为空且为整数");
            return false;
        }
        data.MemberAwardMedal = MemberAwardMedal;

        var TimeLimit = $("#txtTimeLimit").val().trim();
        if (TimeLimit == "" || isNaN(TimeLimit)) {
            alert("时间限制不能为空且为整数");
            return false;
        }
        data.TimeLimit = TimeLimit;

        var Innings = $("#txtInnings").val().trim();
        if (Innings == "" || isNaN(Innings)) {
            alert("完成任务所需局数不能为空且为整数");
            return false;
        }
        data.Innings = Innings;

        var TaskDescription = $("#txtTaskDescription").val().trim();
        data.TaskDescription = TaskDescription;
        AjaxSubmit("/Task/DoTaskInfo", data, callBack, "del");
    }

    //回调函数
    function callBack(jsonData, fname) {
        switch (fname) {
            case "del":
                alert(jsonData.Msg);
                window.location.href = "/Task/Index";
                //window.opener.location.reload();
                break;
        }
    }
</script>
</body>
</html>
