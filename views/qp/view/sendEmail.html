<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width"/>
    <title>后台系统 - 邮件系统</title>
    <link href="../Content/Admin/css/bootstrap-cerulean.min.css" rel="stylesheet"/>
    <link href="../Content/Admin/css/charisma-app.css" rel="stylesheet"/>
    <link href="../Content/common.css" rel="stylesheet"/>
    <link href="../Content/layui-v2.5.4/layui/css/layui.css" rel="stylesheet"/>
    <style type="text/css">
        .panel-body .row div:first-child {
            text-align: right;
        }

        .layui-upload-list {
            width: 100px;
            height: 100px;
            overflow: hidden;
        }

        .panel-body .row div:first-child {
            width: 120px;
        }

        body {
            overflow-y: scroll !important;
        }

        [v-cloak] {
            display: none;
        }
    </style>
</head>
<body>
<div id="app" v-cloak>
    <div>
        <div class="box-inner margin-t-10">
            <div class="box-header well" data-original-title="">
                <h2><i class="glyphicon glyphicon-hand-right"></i> 你当前位置：后台系统 - 邮件系统 - 发送邮件 </h2>
                <div class="box-icon">
                    <a href="#" class="btn btn-round btn-default" onclick="history.go(0);">
                        <i class="glyphicon glyphicon-repeat"></i>
                    </a>
                    <a href="#" class="btn btn-minimize btn-round btn-default">
                        <i class="glyphicon glyphicon-chevron-up"></i>
                    </a>
                </div>
            </div>
            <div class="box-content" style="overflow: hidden; display: block;">
                <div class="panel panel-primary">
                    <div class="panel-body">
                        <div class="row">
                            <div class="inline">
                                <select id="pid" v-model="add.send_type" class="form-control input-sm">
                                    <option value="1">收件人标识</option>
                                    <option value="2">收件人账号</option>
                                    <option value="3">渠道号</option>
                                    <option value="4">全渠道</option>
                                </select>
                            </div>
                            <div class="inline">
                                <input class="form-control input-sm"
                                       type="text"
                                       id="identify"
                                       name="identify"
                                       v-model.trim="add.send_identify"
                                       placeholder="请输入">
                            </div>
                        </div>
                        <div class="row">
                            <div class="inline">邮件标题：</div>
                            <div class="inline">
                                <input class="form-control input-sm input-width-238"
                                       id='title' type="text"
                                       name="title"
                                       v-model="add.title"
                                       v-validate="'required'"
                                       placeholder="请输入邮件标题">
                            </div>
                            <div class="inline wrong" v-show="errors.has('title')">* 请输入邮件标题！</div>
                        </div>
                        <div class="row">
                            <div class="inline">邮件类型：</div>
                            <div class="inline">
                                <input type="radio" id='type-txt' name="email-type" value="1" v-model="add.type">
                                <label for="type-txt">普通邮件</label>
                                <input type="radio" id='type-moy' name="email-type" value="2" v-model="add.type">
                                <label for="type-moy">红包邮件</label>
                            </div>
                        </div>
                        <section v-if="add.type == 2">
                            <div class="row">
                                <div class="inline">红包类型：</div>
                                <div class="inline">
                                    <input type="radio" id='type-rnd' name="package-type" value="1"
                                           v-model="add.hb_type">
                                    <label for="type-rnd">随机红包</label>
                                    <input type="radio" id='type-fix' name="package-type" value="2"
                                           v-model="add.hb_type">
                                    <label for="type-fix">普通红包</label>
                                </div>
                            </div>
                            <div class="row" v-if="add.hb_type == 1">
                                <div class="inline">红包金额：</div>
                                <div class="inline">
                                    <input class="form-control input-sm inline input-width-100"
                                           id='real_min' type="text" placeholder="金额最小值"
                                           name="real_min"
                                           v-model="add.min" v-validate="'required|decimal:2|min_value:0'">&nbsp;-&nbsp;
                                    <input class="form-control input-sm inline input-width-100"
                                           id='real_max' type="text" placeholder="金额最大值"
                                           name="real_max"
                                           v-model="add.max" v-validate="'required|decimal:2|min_value:0'">
                                </div>
                                <div class="inline wrong" v-show="errors.has('real_max') || errors.has('real_min')">
                                    红包金额不合法
                                </div>
                            </div>
                            <div class="row" v-else>
                                <div class="inline">红包金额：</div>
                                <div class="inline">
                                    <input class="form-control input-sm inline input-width-100"
                                           id='real_max' type="text" placeholder="红包金额"
                                           name="real_max"
                                           v-model="add.max" v-validate="'required|decimal:2|min_value:0'">
                                </div>
                                <div class="inline wrong" v-show="errors.has('real_max')">红包金额不合法</div>
                            </div>
                            <div class="row">
                                <div class="inline">虚拟金额：</div>
                                <div class="inline">
                                    <input class="form-control input-sm inline input-width-100"
                                           id='min' type="text" placeholder="min"
                                           name="min"
                                           v-model="add.xnmin" v-validate="'required|decimal:2|min_value:0'">&nbsp;-&nbsp;
                                    <input class="form-control input-sm inline input-width-100"
                                           id='max' type="text" placeholder="max"
                                           name="max"
                                           v-model="add.xnmax" v-validate="'required|decimal:2|min_value:0'">
                                </div>
                                <div class="inline wrong" v-show="errors.has('min')|errors.has('max')">金额不合法</div>
                                <div class="inline">客户端提示金额区间</div>
                            </div>
                        </section>
                        <section v-else>
                            <div class="row">
                                <div class="inline" style="vertical-align: top">邮件内容：</div>
                                <div class="inline">
                                    <textarea class="form-control "
                                              id="content" style="width: 300px" rows="5" type="text"
                                              name="content"
                                              placeholder="请输入邮件内容"
                                              v-model="add.content"
                                              v-validate="'required'">
                                    </textarea>
                                </div>
                                <div class="inline wrong" v-show="errors.has('content')">* 请输入邮件内容！</div>
                            </div>
                        </section>
                    </div>
                    <div class="panel-footer">
                        <div class="row">
                            <div class="col-md-1" style="text-align:right;"></div>
                            <div class="col-md-4" style="text-align:left;">
                                <a class="btn btn-danger" href='javascript:window.close()'>
                                    <i class="glyphicon glyphicon-off"></i>关闭
                                </a>
                                &nbsp;&nbsp;&nbsp;&nbsp;
                                <button type="button" class="btn btn-outline-success" @click="save"><i
                                        class="glyphicon glyphicon-send"></i>保存
                                </button>
                            </div>
                            <div class="col-md-4" style="text-align:left;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="../Scripts/jquery-1.10.2.min.js"></script>
<script src="../Scripts/vue.min.js"></script>
<script src="../Scripts/comm.js"></script>
<script src="../Content/layui-v2.5.4/layui/layui.js"></script>
<script src="../Content/veevalidate/vee-validate.js"></script>
<script src="../Content/veevalidate/zh_CN.js"></script>
<script src="../Content/veevalidate/config.js"></script>
<script>
    layui.use('layer', function () {
        var layer = layui.layer
    })

    var app = new Vue({
        el: '#app',
        data: {
            add: {
                send_type: 1,//接收邮件的类型
                send_identify: '',
                title: '',
                content: '',
                type: 1,//邮件类型
                hb_type: 1,//红包类型
                min: '',
                max: '',
                xnmin: '',
                xnmax: '',
            }
        },
        methods: {
            save: function () {
                var _this = this;
                var index;
                if (_this.add.send_type != 4) { //全渠道邮件不需要输入收件人信息
                    if (_this.add.send_identify == "") {
                        return layer.alert('请输入收件人信息！')
                    }
                }
                if (_this.add.type == 2) {
                    if (_this.add.hb_type == 1) {
                        if (parseFloat(_this.add.min) > parseFloat(_this.add.max)) {
                            return layer.msg('红包的最大金额不能低于最小金额',{time:1000,icon:2})
                        }
                    } else {
                        _this.add.min = 0
                    }
                    if (parseFloat(_this.add.xnmin) > parseFloat(_this.add.xnmax)) {
                        return layer.msg('最大虚拟金额不能低于最小虚拟金额',{time:1000,icon:2})
                    }
                } else {
                    // _this.add.hb_type = 1;//红包类型
                    // _this.add.min = '';
                    // _this.add.max = '';
                    // _this.add.xnmin = '';
                    // _this.add.xnmax = '';
                }
                // var postData = {
                //     send_type: _this.add.send_type,
                //     send_identify: _this.add.send_identify,
                //     title: _this.add.title,
                //     content: _this.add.content,
                //     type:_this.add.type
                // }
                // console.log(postData);
                this.$validator.validate().then(valid => {
                    if (valid) {
                        index = layer.load(1, {
                            shade: [0.1, '#fff'] //0.1透明度的白色背景
                        });
                        $.post(qp_url + 'admin/Email/addEmail?token=' + getStorage('token'), _this.add, function (res) {
                            if (res.status == 1) {
                                layer.msg(res.msg, {time: 1000, icon: 1})
                                setTimeout(function () {
                                    window.close()
                                }, 1000)
                                window.opener.reloadTable()
                            } else {
                                layer.msg(res.msg, {time: 1000, icon: 2})
                            }
                            layer.closeAll('loading')
                        }, 'json')
                    } else {
                        layer.msg('输入信息不完整/不合法', {time: 1000, icon: 2})
                    }
                })
            }
        }
    })

    function save() {
        var index = layer.load(1, {
            shade: [0.1, '#fff'] //0.1透明度的白色背景
        });
        var postData = {
            send_type: $('#pid').val(),
            send_identify: $('#identify').val(),
            title: $('#title').val(),
            content: $('#content').val(),
        }
        console.log(postData);
        if ($('#pid').val() != 4) {
            if (postData.send_identify.trim() == "") {
                layer.alert('请输入收件人信息！')
                return
            }
        }
        if (postData.title.trim() == "") {
            layer.alert('请输入邮件标题！')
            return
        }
        if (postData.content.trim() == "") {
            layer.alert('请输入邮件内容！')
            return
        }
        $.post(qp_url + 'admin/Email/addEmail?token=' + getStorage('token'), postData, function (res) {
            if (res.status == 1) {
                layer.msg(res.msg, {time: 1000, icon: 1})
                setTimeout(function () {
                    window.close()
                }, 1000)
                window.opener.reloadTable()
            } else {
                layer.msg(res.msg, {time: 1000, icon: 2})
            }
            layer.close(index)
        }, 'json')
    }
</script>
</body>
</html>
